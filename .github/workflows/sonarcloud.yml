
name: Grilo SC Analysis for Java (Maven/Gradle)

on:
  push:
    branches: [ "master" ]
  workflow_dispatch: {}

jobs:
  sonar-analysis:
    name: SonarCloud Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # DETECÇÃO INTELIGENTE DO TIPO DE PROJETO E VERSÃO JAVA
      - name: Detect Project Type and Java Version
        id: project_info
        run: |
          # 1. Procura Maven (pom.xml)
          POM_PATH=$(find . -maxdepth 3 -name "pom.xml" -not -path "*/target/*" | head -n 1)
          
          # 2. Procura Gradle (gradlew ou build.gradle)
          GRADLE_PATH=$(find . -maxdepth 3 -name "gradlew" -o -name "build.gradle" -o -name "build.gradle.kts" | head -n 1)

          if [ -n "$POM_PATH" ]; then
            echo "Build System: Maven detected at $POM_PATH"
            echo "build_system=maven" >> $GITHUB_OUTPUT
            echo "build_file=$POM_PATH" >> $GITHUB_OUTPUT
            
            # Detecta versão Java do POM
            JAVA_VERSION=$(mvn -q -Dexec.executable=echo -Dexec.args='${maven.compiler.release}' --non-recursive exec:exec -f "$POM_PATH" | grep -o '^[0-9][0-9]*' || echo '17')
          
          elif [ -n "$GRADLE_PATH" ]; then
            echo "Build System: Gradle detected at $GRADLE_PATH"
            echo "build_system=gradle" >> $GITHUB_OUTPUT
            
            # Ajusta caminho se for wrapper
            if [[ "$GRADLE_PATH" == *"gradlew"* ]]; then
               DIR=$(dirname "$GRADLE_PATH")
               echo "gradle_wrapper_dir=$DIR" >> $GITHUB_OUTPUT
            fi
            
            # Gradle moderno geralmente requer Java 17+
            JAVA_VERSION='17'
          else
             echo "::warning::Nenhum build system detectado. Usando defaults."
             echo "build_system=unknown" >> $GITHUB_OUTPUT
             JAVA_VERSION='17'
          fi
          
          echo "Java Version Selected: $JAVA_VERSION"
          echo "java_version=$JAVA_VERSION" >> $GITHUB_OUTPUT

      - name: Set up JDK
        uses: actions/setup-java@v3
        with:
          java-version: ${{ steps.project_info.outputs.java_version }}
          distribution: 'temurin'
          cache: 'maven' # Cache tenta maven por padrão, não quebra se for gradle

      # --- EXECUÇÃO MAVEN (TRY-CATCH) ---
      
      - name: Maven Analysis (Full)
        if: steps.project_info.outputs.build_system == 'maven'
        id: maven_full
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: mvn -B verify org.sonarsource.scanner.maven:sonar-maven-plugin:sonar -f ${{ steps.project_info.outputs.build_file }} -Dsonar.projectKey=grilo-org_20260120T165104_lukninja97_CarsExplorer -Dsonar.projectName=20260120T165104_lukninja97_CarsExplorer -Dsonar.host.url=https://sonarcloud.io -Dsonar.organization=grilo-org

      - name: Maven Analysis (Fallback - Skip Tests)
        if: steps.project_info.outputs.build_system == 'maven' && steps.maven_full.outcome == 'failure'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          echo "::warning::Build Maven falhou. Tentando sem testes."
          mvn -B verify org.sonarsource.scanner.maven:sonar-maven-plugin:sonar -Dmaven.test.skip=true -f ${{ steps.project_info.outputs.build_file }} -Dsonar.projectKey=grilo-org_20260120T165104_lukninja97_CarsExplorer -Dsonar.projectName=20260120T165104_lukninja97_CarsExplorer -Dsonar.host.url=https://sonarcloud.io -Dsonar.organization=grilo-org

      # --- EXECUÇÃO GRADLE (TRY-CATCH) ---

      - name: Gradle Analysis
        if: steps.project_info.outputs.build_system == 'gradle'
        id: gradle_run
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          # Se tiver wrapper, usa ele
          if [ -n "${{ steps.project_info.outputs.gradle_wrapper_dir }}" ]; then
            cd ${{ steps.project_info.outputs.gradle_wrapper_dir }}
            chmod +x gradlew
            ./gradlew sonar -Dsonar.projectKey=grilo-org_20260120T165104_lukninja97_CarsExplorer -Dsonar.projectName=20260120T165104_lukninja97_CarsExplorer -Dsonar.host.url=https://sonarcloud.io -Dsonar.organization=grilo-org || ./gradlew sonarqube -Dsonar.projectKey=grilo-org_20260120T165104_lukninja97_CarsExplorer -Dsonar.projectName=20260120T165104_lukninja97_CarsExplorer -Dsonar.host.url=https://sonarcloud.io -Dsonar.organization=grilo-org
          else
            # Fallback para gradle instalado
            gradle sonar -Dsonar.projectKey=grilo-org_20260120T165104_lukninja97_CarsExplorer -Dsonar.projectName=20260120T165104_lukninja97_CarsExplorer -Dsonar.host.url=https://sonarcloud.io -Dsonar.organization=grilo-org
          fi
          
      - name: Gradle Analysis (Fallback - Skip Tests & Lint)
        if: steps.project_info.outputs.build_system == 'gradle' && steps.gradle_run.outcome == 'failure'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
           echo "::warning::Build Gradle falhou. Tentando sem testes."
           if [ -n "${{ steps.project_info.outputs.gradle_wrapper_dir }}" ]; then
            cd ${{ steps.project_info.outputs.gradle_wrapper_dir }}
            # ADICIONADO -x lint AQUI TAMBÉM
            ./gradlew sonar -x test -x lint -Dsonar.projectKey=grilo-org_20260120T165104_lukninja97_CarsExplorer -Dsonar.projectName=20260120T165104_lukninja97_CarsExplorer -Dsonar.host.url=https://sonarcloud.io -Dsonar.organization=grilo-org
           else
            gradle sonar -x test -x lint -Dsonar.projectKey=grilo-org_20260120T165104_lukninja97_CarsExplorer -Dsonar.projectName=20260120T165104_lukninja97_CarsExplorer -Dsonar.host.url=https://sonarcloud.io -Dsonar.organization=grilo-org
           fi
